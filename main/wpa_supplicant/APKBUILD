# Contributor: SÃ¶ren Tempel <soeren+alpine@soeren-tempel.net>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=wpa_supplicant
pkgver=2.8
pkgrel=3
pkgdesc="A utility providing key negotiation for WPA wireless networks"
url="https://w1.fi/wpa_supplicant/"
arch="all"
license="BSD-3-Clause"
subpackages="$pkgname-doc $pkgname-openrc"
makedepends="linux-headers openssl-dev dbus-dev libnl3-dev pcsc-lite-dev"
source="https://w1.fi/releases/$pkgname-$pkgver.tar.gz

	wpa_supplicant.initd
	wpa_supplicant.confd
	wpa_cli.confd
	wpa_cli.initd

	eloop.patch
	0001-SAE-Use-const_time_memcmp-for-pwd_value-prime-compar.patch
	0002-EAP-pwd-Use-const_time_memcmp-for-pwd_value-prime-co.patch
	0003-OpenSSL-Use-BN_bn2binpad-or-BN_bn2bin_padded-if-avai.patch
	0004-SAE-Run-through-prf-result-processing-even-if-it-pri.patch
	0005-EAP-pwd-Run-through-prf-result-processing-even-if-it.patch
	0006-dragonfly-Disable-use-of-groups-using-Brainpool-curv.patch
	CVE-2019-16275.patch

	config
	wpa_cli.sh"

# secfixes:
#   2.8-r3:
#     - CVE-2019-16275
#   2.8-r2:
#     - CVE-2019-13377
#   2.8-r0:
#     - CVE-2019-11555
#   2.7-r3:
#     - CVE-2019-11555
#   2.7-r2:
#     - CVE-2019-9494
#     - CVE-2019-9495
#     - CVE-2019-9497
#     - CVE-2019-9498
#     - CVE-2019-9499
#   2.7-r0:
#     - CVE-2017-13077
#     - CVE-2017-13078
#     - CVE-2017-13079
#     - CVE-2017-13080
#     - CVE-2017-13081
#     - CVE-2017-13082
#     - CVE-2017-13086
#     - CVE-2017-13087
#     - CVE-2017-13088
#   2.6-r14:
#     - CVE-2018-14526
#   2.6-r7:
#     - CVE-2017-13077
#     - CVE-2017-13078
#     - CVE-2017-13079
#     - CVE-2017-13080
#     - CVE-2017-13081
#     - CVE-2017-13082
#     - CVE-2017-13086
#     - CVE-2017-13087
#     - CVE-2017-13088

prepare() {
	cd "$builddir"
	default_prepare

	# Copy our configuration file to the build directory
	cp "$srcdir"/config "$builddir"/wpa_supplicant/.config
}

build() {
	cd "$builddir"/wpa_supplicant
	make LIBDIR=/lib BINDIR=/sbin
}

check() {
	cd "$builddir"/wpa_supplicant
	make eapol_test
}

package() {
	cd "$builddir"/wpa_supplicant
	make DESTDIR="$pkgdir" LIBDIR=/lib BINDIR=/sbin install
	install -Dm644 wpa_supplicant.conf \
		"$pkgdir"/usr/share/doc/wpa_supplicant/examples/wpa_supplicant.conf
	install -Dm755 "$srcdir"/wpa_cli.sh \
		"$pkgdir"/etc/wpa_supplicant/wpa_cli.sh

	local man=
	for man in doc/docbook/*.?; do
		install -Dm644 "$man" \
			"$pkgdir"/usr/share/man/man${man##*.}/${man##*/}
	done
	install -Dm755 eapol_test "$pkgdir"/sbin/eapol_test

	# dbus
	cd dbus
	install -d "$pkgdir"/etc/dbus-1/system.d
	install -m644 dbus-wpa_supplicant.conf \
		"$pkgdir"/etc/dbus-1/system.d/wpa_supplicant.conf
	install -d "$pkgdir"/usr/share/dbus-1/system-services
	install fi.w1.wpa_supplicant1.service \
		"$pkgdir"/usr/share/dbus-1/system-services
	install -d "$pkgdir"/var/run/wpa_supplicant

	# openrc runscripts
	install -Dm755 "$srcdir"/wpa_supplicant.initd \
		"$pkgdir"/etc/init.d/wpa_supplicant
	install -Dm644 "$srcdir"/wpa_supplicant.confd \
		"$pkgdir"/etc/conf.d/wpa_supplicant
	install -Dm755 "$srcdir"/wpa_cli.initd \
		"$pkgdir"/etc/init.d/wpa_cli
	install -Dm644 "$srcdir"/wpa_cli.confd \
		"$pkgdir"/etc/conf.d/wpa_cli
}

sha512sums="b37d254d32a4b7a1f95fcb18ec1be0ffb9d025e0b21c42c53acc4cd839be355df1b125b32cc073f9fe09b746807321e23dbe25dc2fc8a7cafa1e71add69f245b  wpa_supplicant-2.8.tar.gz
2758109ccdd7d13e3839fc640ff2c321d5474d62a9dfce40ceb3c89e09b5cd6fe8b5f2f3184380513dc0e10f166669965e92005c0288c3f0814fd084d9673932  wpa_supplicant.initd
cbfc6b80cb47d4e33415018054a0d8ba39acbadbc3e44776afa918cc4c1e4d36ed3dd809b3448332575ac4fa0b82ad77d7530563f0b9f5e1374a5deea73a3b93  wpa_supplicant.confd
c3db077fa78dd296d90d07626cb4e684f87618a77ffd51c1ae04b47be7bc0db1e9a3e0f7442acef21c081f6bb782f150cbbd3d0bf245d6ab43f19da3899b53b9  wpa_cli.confd
a0ac905ef23af18f1899a797e18157a54fa509c7cc3c59583de768a493d750876bbc0a89237373b67171e7c84259d2350d2c0e33d8e1ea56db9a2e5f27b64128  wpa_cli.initd
2be055dd1f7da5a3d8e79c2f2c0220ddd31df309452da18f290144d2112d6dbde0fc633bb2ad02c386a39d7785323acaf5f70e5969995a1e8303a094eb5fe232  eloop.patch
0dfc8728cfc3a86f7a182a7f71213b94f64880ee4470e2a939c83059df5af7a60d56ec0a8a5f2f717838995f4ef2c6a8fb909324875b0f12a52040239092d115  0001-SAE-Use-const_time_memcmp-for-pwd_value-prime-compar.patch
88b28f73267b5031417e527b4e2eea117e62649862bafbe99b83b77bade56612283279906c8d1a4c997fb8f32fc7a6cf8c88931a64e9520d1bf45fbdb0e6c381  0002-EAP-pwd-Use-const_time_memcmp-for-pwd_value-prime-co.patch
01389b9d3951bf1148894c0f4b45d22ef8352a8fe1090721d17216506581305726f6a6c0ebff88479e5342330e75fc04db9201d7d65d4cc6b01a5f7258dc26f9  0003-OpenSSL-Use-BN_bn2binpad-or-BN_bn2bin_padded-if-avai.patch
1fabc83a5e05ce3d09c89e37365d038bd0eec3a76683966ad172eac3c2c884dbc24fc6ca11c27a8f4582e886d0f1cde73bbede4484352b42a3f686d89d088fff  0004-SAE-Run-through-prf-result-processing-even-if-it-pri.patch
bcae73930c35d441c5615970c305abb3dff293fdec16df50823e57419b22d1aac0e780970619e0c78b4482b7d07962bcf6162706a20e20f7b21a3a10f500eff1  0005-EAP-pwd-Run-through-prf-result-processing-even-if-it.patch
4734a8ab8ba1e91fc9e3d729f34527c14c291df238b02adea5acc04b0361b41d4bffca2fb13a4f464e9f007fa624117af4f50d755cb41a3129b4868da91bdf9a  0006-dragonfly-Disable-use-of-groups-using-Brainpool-curv.patch
63710cfb0992f2c346a9807d8c97cbeaed032fa376a0e93a2e56f7742ce515e9c4dfadbdb1af03ba272281f639aab832f0178f67634c222a5d99e1d462aa9e38  CVE-2019-16275.patch
6707991f9a071f2fcb09d164d31d12b1f52b91fbb5574b70b8d6f9727f72bbe42b03dd66d10fcc2126f5b7e49ac785657dec90e88b4bf54a9aa5638582f6e505  config
212c4265afce2e72b95a32cd785612d6c3e821b47101ead154136d184ac4add01434ada6c87edbb9a98496552e76e1a4d79c6b5840e3a5cfe5e6d602fceae576  wpa_cli.sh"
